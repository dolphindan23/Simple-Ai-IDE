Two “must change” points
1) Dangerous-change confirmation must be server-enforced with a nonce

You wrote: “frontend shows confirmation; backend rejects unconfirmed dangerous diffs.”

Good — but make it tamper-proof:

When validation detects danger, backend returns:

requiresConfirmation: true

confirmationToken: <signed token or random nonce>

a dangerSummary list (files + reasons)

Then applyDiff requires that token.

Why: otherwise someone can hit your apply endpoint directly and bypass UI.

2) Limits must be enforced even when auto-fix is ON

Auto-fix loops are where patches can explode.

Make sure:

maxFilesPerPatch / maxLinesPerPatch apply to:

initial implement patch

each TestFixer patch attempt

Small but important improvements (low effort, high payoff)
A) “Sensitive paths” list should be configurable

Hardcoding “scripts/, server/…” is fine as defaults, but expose in Settings:

sensitivePaths: string[] (glob-like)

default includes:

server/**

scripts/**

package.json

*.config.*

.env*

.simpleaide/** (usually block)

B) Add a “dry run” option for git apply

Before applying modifications:

run git apply --check first

if fails, return clean error before touching anything

This reduces half-applied states.

C) Handle “git not installed” gracefully

Since you depend on subprocess git:

detect once at startup or first apply

if missing, show: “Git required for patch apply; install git or switch to pure-js apply”

UX guidance: keep it simple

You’re adding a lot — don’t clutter the UI.

Put these in AI Team panel (not full Settings)

Auto-fix toggle (ON/OFF)

Attempts (3 default)

“Safe mode” indicator when limits are strict

Put these in Settings (advanced)

max files/lines per patch

sensitive path patterns

verify command allowlist

whitespace mode (optional)

Acceptance checklist (use this to mark done)
Auto-fix

 Default OFF

 When OFF: Verify runs once, no retries

 When ON: retries happen up to N attempts

 Each attempt produces a new run artifact folder (attempt_1/attempt_2/...)

 Limits apply to every attempt

Patch size limits

 Patch modifying > maxFiles blocks with clear message

 Patch modifying > maxLines blocks with clear message

 Message includes “found X, limit Y”

Dangerous changes

 Deleting a file triggers requiresConfirmation

 Editing sensitive path triggers requiresConfirmation

 Apply endpoint rejects if token missing/invalid

 UI shows a simple diff summary + “Confirm apply”

Verify allowlist

 Verify executes only commands in allowlist

 Commands come only from Settings / package.json scripts

 Model output cannot alter verify commands

Git apply hardening

 Uses repo root as cwd

 Uses git apply --check before apply

 Uses --whitespace=nowarn

 Clean error returned on failure

Copy/paste “final instruction” to the agent

If you want to tighten the plan into one directive:

Implement trust hardening for SimpleAide’s agent edit loop:

Server-enforce patch size limits and dangerous-change confirmation. When validation flags danger, return a confirmationToken and require it on apply.

Apply maxFilesPerPatch/maxLinesPerPatch to every patch including TestFixer retries.

Add configurable sensitivePaths patterns with safe defaults and block .simpleaide/** by default.

For git apply, run git apply --check first and apply with --whitespace=nowarn from repo root.

Verify commands must be allowlisted (from settings/package.json scripts), never model-provided.

Add minimal UI controls: Auto-fix toggle + max attempts in AI Team panel; advanced limits in Settings.

Save artifacts per attempt: validation_report, applied_files, verify logs.